<!doctype html>
<html lang="en">
<head>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coms Test Trainer + Spelling Drill</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html,body,#root{height:100%}</style>
</head>
<body class="bg-neutral-950 text-white">
  <div id="root"></div>

  <!-- Spelling Drill Overlay (hidden by default) -->
  <div id="spelling-overlay" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="window.hideSpelling()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <h2 class="text-lg font-semibold">LE Communications Spelling Drill</h2>
          <button onclick="window.hideSpelling()" class="px-3 py-1.5 rounded bg-neutral-900 text-white hover:bg-neutral-800">Close</button>
        </div>
        <div id="spelling-app" class="max-h-[80vh] overflow-auto">
          <!-- Scoped spelling app with isolated styles and JS -->
          <style>
            #spelling-app { background:#f8fafc; color:#0f172a; }
            #spelling-app .wrap{max-width:860px;margin:16px auto 32px;padding:0 16px}
            #spelling-app h1{font-size:clamp(20px,3vw,28px);margin:0 0 8px}
            #spelling-app .card{background:#ffffff;border-radius:16px;box-shadow:0 6px 24px rgba(2,6,23,.06);padding:18px;margin:14px 0}
            #spelling-app .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
            #spelling-app button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;background:#111827;color:#fff}
            #spelling-app button.sec{background:#334155}
            #spelling-app button.ghost{background:#e2e8f0;color:#0f172a}
            #spelling-app button.ok{background:#16a34a}
            #spelling-app button.bad{background:#dc2626}
            #spelling-app input[type="text"], #spelling-app textarea, #spelling-app select{
              width:100%;padding:14px 16px;border:1.5px solid #cbd5e1;border-radius:12px;font-size:16px
            }
            #spelling-app input[type="text"].wrong{border-color:#dc2626;}
            #spelling-app .meta{color:#475569;font-size:14px}
            #spelling-app .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
            #spelling-app .hide{display:none}
            #spelling-app .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px}
            #spelling-app .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0f172a;color:#fff;padding:2px 6px;border-radius:6px}
            #spelling-app .list li{margin:6px 0}
            #spelling-app .progress{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
            #spelling-app .progress>div{height:100%;width:0;background:#111827}
            #spelling-app details summary{cursor:pointer;font-weight:700}
            #spelling-app .tiny{font-size:12px;color:#64748b}
            #spelling-app .disabled{opacity:.5;pointer-events:none}
          </style>
          <div class="wrap">
            <h1>LE Communications Spelling Drill <span class="pill">Audio + Typed</span></h1>
            <p class="meta">Play the word, type the spelling in <b>ALL CAPS</b>, submit. Lowercase is counted wrong on purpose.</p>

            <div class="card" id="config">
              <h3>1) Load words</h3>
              <textarea id="wordsInput" rows="8" placeholder="Paste one word per line (or comma/space separated)"></textarea>
              <div class="row" style="margin-top:10px">
                <button id="btnDefault">Load academy default (300+)</button>
                <button class="ghost" id="btnClear">Clear</button>
              </div>

              <h3 style="margin-top:18px">2) Options</h3>
              <div class="grid">
                <label>Voice:
                  <select id="voiceSelect"></select>
                </label>
                <label>Speech rate:
                  <input id="rate" type="range" min="0.7" max="1.2" step="0.05" value="0.9">
                  <span id="rateV">0.90</span>
                </label>
                <label>Shuffle:
                  <select id="shuffleMode">
                    <option value="all" selected>All words (random order)</option>
                    <option value="wrong">Only wrong from last run</option>
                  </select>
                </label>
                <label>Auto-advance on correct: <input id="autoNext" type="checkbox" checked></label>
              </div>

              <div class="row" style="margin-top:14px">
                <button id="start">Start</button>
                <button id="practice" class="sec">Practice test (20)</button>
                <span class="meta">Quick keys: <span class="kbd">Space</span> play | <span class="kbd">Enter</span> submit | <span class="kbd">Ctrl</span> + <span class="kbd">Backspace</span> clear</span>
              </div>
            </div>

            <div class="card hide" id="session">
              <div class="row" style="justify-content:space-between;align-items:flex-end">
                <div>
                  <div class="meta">Item <span id="idx">1</span> / <span id="total">0</span></div>
                  <div class="progress"><div id="bar"></div></div>
                </div>
                <div class="meta">Score: <b id="score">0</b></div>
              </div>

              <div class="row" style="margin-top:12px">
                <button id="play">▶ Play</button>
                <button class="sec" id="repeat">Repeat (30% slower)</button>
                <button class="ghost" id="skip">Skip</button>
              </div>

              <div style="margin-top:10px">
                <input id="answer" type="text" placeholder="TYPE IN ALL CAPS" autocomplete="off" spellcheck="false" />
              </div>

              <div class="row" style="margin-top:10px">
                <button id="submit" class="ok">Submit</button>
                <button id="reveal" class="sec">Reveal</button>
              </div>

              <div id="feedback" class="meta" style="min-height:22px;margin-top:6px"></div>
            </div>

            <div id="results" class="card hide"></div>

            <details class="card" id="howto">
              <summary>Tips</summary>
              <ul class="list">
                <li>Practice test mode gives you <b>one attempt</b> per word, 20 items total.</li>
                <li>Train mode lets you Reveal answers and auto-advance on correct.</li>
                <li>Use “wrong only” to target weak spots.</li>
              </ul>
              <p class="tiny">All processing is local in your browser. Nothing is uploaded.</p>
            </details>
          </div>

          <script>
          (function(){
            const root = document.getElementById('spelling-app');
            const $ = sel => root.querySelector(sel);
            const syn = window.speechSynthesis;
            // Audio cues
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            const actx = new AudioCtx();
            function beep(freq=880, dur=0.12, type='sine'){
              const o = actx.createOscillator();
              const g = actx.createGain();
              o.type = type; o.frequency.value = freq;
              o.connect(g); g.connect(actx.destination);
              g.gain.setValueAtTime(0.0001, actx.currentTime);
              g.gain.exponentialRampToValueAtTime(0.2, actx.currentTime+0.01);
              o.start();
              g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+dur);
              o.stop(actx.currentTime+dur+0.01);
            }
            const cueCorrect = ()=>{ beep(1100,0.12,'sine'); setTimeout(()=>beep(1400,0.1,'sine'),110); };
            const cueWrong = ()=>beep(220,0.18,'sawtooth');

            const defaultText = `ALIBI
ALLEY
AMATEUR
AMBULANCE
AMMUNITION
AMNESIA
AMPHETAMINE
AMUSEMENT
ANALYSIS
ANTAGONIZE
APOLOGIZE
APPEARANCE
APPROXIMATELY
ARGUMENT
ARRESTED
ARRIVAL
ARSENAL
SUBPOENA
ARTIFICIAL
ASPIRIN
ASSAULT
ASSISTANCE
EMBEZZLEMENT
EMERGENCY
ENFORCEMENT
ENVIRONMENT
CAPTURE
CARBURETOR
CASHIER
CASUALTY
CEMETERY
CERTIFICATE
CHAUFFEUR
CHEVROLET
CHILDREN
CHRYSLER
CITIZEN
CIVIL
CLIENTELE
COERCION
COINCIDENCE
COLLABORATE
COLLIDE
COLLISION
COMMAND
COMMERCIAL
COMMUNICATE
COMPETENT
KNIFE
KNUCKLES
LABORATORY
LACERATION
DEMONSTRATION
DEPARTMENTAL
DESCEND
DESCRIPTION
DETAILS
DETAINED
DETRIMENTAL
DEXEDRINE
DIAGRAM
DIAMOND
DILATED
DIMENSION
DISARRANGED
DISCREPANCY
DISEASE
DISPATCHED
DISPERSE
DISTRICT
DOUBTFUL
DUPLICATE
ELIGIBLE
EMBARRASS
PERSONNEL
PERSPIRATION
PERVERSION
PHYSICAL
EQUIPMENT
ESTABLISH
EVIDENCE
EXAGGERATE
EXCEPTION
EXHAUSTED
EXHIBITION
EXTORTION
FAMILIAR
FICTITIOUS
FINGERPRINT
FORCIBLE
FOREIGN
FORGERY
FOUND
FRACTURE
FRAUDULENT
GAUGE
GENERATOR
GOVERNMENT
GUARDIAN
HABITS
HALLUCINATION
HANDKERCHIEF
HEIGHT
HEROIN
LANGUAGE
LEGITIMATE
LEISURE
LICENSE
LIEUTENANT
LIFEGUARD
LIQUOR
MACHETE
MAINTAIN
MAINTENANCE
MALICIOUS
MANEUVER
MANNEQUIN
MANSLAUGHTER
MARTIAL
MATERIAL
MEASUREMENT
MILLIMETER
MISCHIEF
MISDEMEANOR
MODEL
MUSTACHE
MUTUAL
NECESSITY
NEGLIGENCE
NEITHER
PISTOL
PORNOGRAPHIC
POSSESSION
POSSIBLE
PRESENCE
PRISONER
PRIVATE
PROCESS
PROFESSIONAL
PROHIBITED
PROPERTY
PROSECUTION
PROSTITUTION
PUNITIVE
PURSUIT
QUARANTINE
QUARREL
QUESTION
QUESTIONING
QUIET
RACIAL
RECKLESS
RECOGNIZE
RECOMMEND
REFERRED
RELEASE
HYDRAULIC
IDENTIFICATION
ILLEGITIMATE
IMMEDIATELY
IMPORTANT
INCOHERENT
INCONSISTENT
INCORRIGIBLE
INDECENT
INFORMANT
INFORMATION
INNOCENT
INTELLIGENCE
INTERROGATE
INTERSECTION
INTERVIEW
INTOXICATION
INVESTIGATE
IRRELEVANT
JEOPARDY
JEWELRY
SUSPICIOUS
TATTOO
TECHNIQUE
TELEVISION
TOBACCO
NOTICEABLE
OBNOXIOUS
OBSCURE
OBSTACLE
OCCASION
OCCURRENCE
OFFENSE
OFFENSIVE
OFFICER
OFFICIAL
OPERATION
OPERATOR
OPPORTUNITY
PARALLELED
PARAPHERNALIA
PARTIALLY
PARTICIPATE
PEDESTRIAN
PENITENTIARY
PERIMETER
PERMANENT
TRANSMIT
TRANSPORT
TRANSACTION
TRANSLATOR
TOURNIQUET
UNDERSTAND
UNIFORM
UNIQUE
URINATE
VISIBLE
WAIVER
WATCHED
WEIGHT
WITNESS
RESISTANCE
RESTAURANT
REVOKED
REVOLVER
SCENE
SCISSORS
SEARCH
SEIZE
SELECTIVE
SEPARATED
SERGEANT
SILHOUETTE
SIMILAR
SITUATION
SOLICITOR
SPANISH
SPECIMEN
STANDARD
SUBTLE
SUICIDE
SURRENDER
VEHICLE
VIAL
VICIOUS
VIETNAMESE
VIOLATION
ABANDONED
ABDUCTION
ABSOLUTE
ACCELERATE
ACCESSORY
ACCIDENTAL
ACCOMPLICE
ACETYLENE
ACHIEVEMENT
ACQUAINTANCE
ADDICTED
ADEQUATE
ADJACENT
ADJUSTABLE
ADMINISTRATIVE
ADMISSIBLE
ADMONISH
AFFIDAVIT
AFRAID
AGENCY
AGGRESSOR
ALCOHOL
ALIAS
ATTACK
ATTEMPT
AUTHORIZE
AUTOMATIC
AVENUE
BARBITURATE
BARREL
BARRICADE
BATON
BECAUSE
BEHAVIOR
BELLIGERENT
BENEFICIAL
BEVERAGE
BICYCLE
BINOCULARS
BOISTEROUS
BOULEVARD
BRUISE
BUREAU
BURGLARY
CALENDAR
CALIBER
COMPLAINT
COMPLETED
CONCENTRATION
CONDEMN
CONDITION
CONFESSION
CONSPIRACY
CONSTABLE
CONSTITUTION
CONVENIENCE
CONVULSION
CORROBORATE
COUNTERFEIT
CRUELTY
CRUISING
CYLINDER
DANGEROUS
DAUGHTER
DEADLY
DECEASED
DEFECATE
DEFENSE
DELIBERATE`;

            const defaultListArr = defaultText.trim().split(/\n+/).map(w=>w.trim());
            document.addEventListener('DOMContentLoaded', ()=>{ const t = $('#wordsInput'); if(t) t.value = defaultListArr.join("\n"); });

            // Expose a getter for the current spelling list to the main app
            window.LE_SPELLING_DEFAULT = defaultListArr.slice();
            window.getSpellingWordList = function(){
              try {
                const root = document.getElementById('spelling-app');
                const t = root ? root.querySelector('#wordsInput') : null;
                const raw = t && t.value ? t.value : window.LE_SPELLING_DEFAULT.join("\n");
                const arr = raw.replace(/\r/g,'\n').split(/[\s,]+/).map(w=>w.trim()).filter(Boolean);
                const seen = new Set(), out=[];
                for(const w of arr){ const up = w.toUpperCase(); if(!seen.has(up)){ seen.add(up); out.push(up);} }
                return out;
              } catch { return window.LE_SPELLING_DEFAULT.slice(); }
            };

            const state = { wordsAll:[], wordsRun:[], idx:0, score:0, wrongList:[], practice:false };

            function parseWords(raw){
              if(!raw) return [];
              const arr = raw.replace(/\r/g,'\n').split(/[\s,]+/).map(w=>w.trim()).filter(Boolean);
              const seen = new Set(), out=[];
              for(const w of arr){ const up = w.toUpperCase(); if(!seen.has(up)){ seen.add(up); out.push(up);} }
              return out;
            }
            function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
            function speak(word, rateFactor=1){
              if(!word) return;
              const u = new SpeechSynthesisUtterance(word);
              const name = (document.getElementById('voiceSelect')||{}).value;
              const v = window.speechSynthesis.getVoices().find(x=>x.name===name);
              if(v) u.voice = v;
              const baseEl = document.getElementById('rate');
              const base = parseFloat((baseEl && baseEl.value) || '0.9');
              u.rate = Math.max(0.5, Math.min(1.5, base * rateFactor));
              u.volume = 1; u.pitch = 1;
              window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
            }
            window.spellSpeak = speak; // for exam mode
            function populateVoices(){
              const sel = $('#voiceSelect'); if(!sel) return; sel.innerHTML='';
              const voices = syn.getVoices().filter(v=>v.lang.startsWith('en'));
              voices.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; if(/en-US/.test(v.lang) && sel.selectedIndex===-1) opt.selected=true; sel.appendChild(opt); });
            }
            populateVoices();
            if (typeof speechSynthesis !== 'undefined') speechSynthesis.onvoiceschanged = populateVoices;

            

// Minimal controller to make Start and Practice(20) work
const ui = {
  cfg: $('#config'),
  ses: $('#session'),
  res: $('#results'),
  wordsInput: $('#wordsInput'),
  btnDefault: $('#btnDefault'),
  btnClear: $('#btnClear'),
  voiceSelect: $('#voiceSelect'),
  rate: $('#rate'),
  rateV: $('#rateV'),
  shuffleMode: $('#shuffleMode'),
  autoNext: $('#autoNext'),
  btnStart: $('#start'),
  btnPractice: $('#practice'),
  idx: $('#idx'),
  total: $('#total'),
  bar: $('#bar'),
  score: $('#score'),
  play: $('#play'),
  repeat: $('#repeat'),
  skip: $('#skip'),
  answer: $('#answer'),
  submit: $('#submit'),
  reveal: $('#reveal'),
  feedback: $('#feedback'),
};

// Create extra controls for problem-list persistence/export
(function addProblemControls(){
  const row = document.createElement('div');
  row.className = 'row';
  row.style.marginTop = '8px';
  row.innerHTML = `
    <button class="sec" id="btnUseProblems">Use Problem List</button>
    <button class="sec" id="btnExportProblems">Export Problem List</button>
    <button class="sec" id="btnClearProblems">Clear Problem List</button>
    <span class="meta" id="problemCount" style="margin-left:8px"></span>
  `;
  if (ui.cfg) ui.cfg.appendChild(row);
})();

function getProblemStoreKey(){ return 'LE_SPELLING_PROBLEMS_V1'; }
function readProblems(){
  try {
    const raw = localStorage.getItem(getProblemStoreKey());
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}
function writeProblems(list){
  const uniq = Array.from(new Set(list.map(w=>String(w||'').trim().toUpperCase()).filter(Boolean)));
  localStorage.setItem(getProblemStoreKey(), JSON.stringify(uniq));
  updateProblemCount();
  return uniq;
}
function addProblems(list){
  const existing = new Set(readProblems());
  for (const w of list) existing.add(String(w||'').trim().toUpperCase());
  return writeProblems(Array.from(existing));
}
function clearProblems(){ localStorage.removeItem(getProblemStoreKey()); updateProblemCount(); }
function updateProblemCount(){
  const el = document.getElementById('problemCount');
  if (el) {
    const n = readProblems().length;
    el.textContent = n ? `Saved problems: ${n}` : `Saved problems: 0`;
  }
}
updateProblemCount();

// Wire defaults
if (ui.btnDefault) ui.btnDefault.onclick = () => { $('#wordsInput').value = defaultListArr.join("\n"); };
if (ui.btnClear) ui.btnClear.onclick = () => { $('#wordsInput').value = ''; };
if (ui.rate) ui.rate.oninput = () => { ui.rateV.textContent = parseFloat(ui.rate.value).toFixed(2); };

// Problem controls handlers
const btnUseProblems = document.getElementById('btnUseProblems');
const btnExportProblems = document.getElementById('btnExportProblems');
const btnClearProblems = document.getElementById('btnClearProblems');
if (btnUseProblems) btnUseProblems.onclick = () => {
  const probs = readProblems();
  if (!probs.length) { alert('No saved problem words yet. Finish a run to save misses.'); return; }
  $('#wordsInput').value = probs.join("\n");
  if (ui.shuffleMode) ui.shuffleMode.value = 'wrong'; // encourage wrong-only loop
};
if (btnExportProblems) btnExportProblems.onclick = () => {
  const probs = readProblems();
  const blob = new Blob([probs.join("\n")], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'problem_words.txt';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
};
if (btnClearProblems) btnClearProblems.onclick = () => {
  if (confirm('Clear saved problem words?')) clearProblems();
};

function show(el){ el.classList.remove('hide'); }
function hide(el){ el.classList.add('hide'); }
function resetSession(){
  state.idx = 0;
  state.score = 0;
  ui.feedback.textContent = '';
  ui.answer.value = '';
  ui.answer.classList.remove('wrong');
}
function startRun({practice=false}={}){
  const all = window.getSpellingWordList ? window.getSpellingWordList() : defaultListArr.slice();
  state.practice = practice;
  if (practice) {
    // sample 20 unique at random
    const a = all.slice();
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    state.wordsRun = a.slice(0, Math.min(20, a.length));
  } else {
    const mode = ui.shuffleMode.value;
    if (mode === 'wrong' && state.wrongList.length) {
      const uniq = Array.from(new Set(state.wrongList));
      state.wordsRun = uniq.slice();
    } else {
      state.wordsRun = all.slice();
    }
    // randomize order
    for(let i=state.wordsRun.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [state.wordsRun[i],state.wordsRun[j]]=[state.wordsRun[j],state.wordsRun[i]]; }
  }
  resetSession();
  ui.total.textContent = String(state.wordsRun.length);
  ui.score.textContent = '0';
  ui.bar.style.width = '0%';
  hide(ui.cfg); hide(ui.res); show(ui.ses);
  ui.answer.focus();
  renderItem();
}
function renderItem(){
  if (state.idx >= state.wordsRun.length) { return finishRun(); }
  const n = state.idx + 1;
  ui.idx.textContent = String(n);
  const pct = Math.round((n-1)/state.wordsRun.length*100);
  ui.bar.style.width = pct + '%';
  ui.feedback.textContent = '';
  ui.answer.value = '';
  ui.answer.classList.remove('wrong');
}
function finishRun(){
  // persist missed words into localStorage
  if (state.wrongList.length) addProblems(state.wrongList);
  hide(ui.ses); show(ui.res);
  const wrong = state.wrongList.slice();
  const ok = state.wordsRun.length - wrong.length;
  ui.res.innerHTML = `<div class="font-semibold mb-2">Results</div>
    <div class="meta">Score: <b>${ok}</b> / ${state.wordsRun.length}</div>
    ${wrong.length ? `<div class="mt-2"><div class="meta mb-1">Missed (${wrong.length})</div><ul class="list">${wrong.map(w=>`<li>${w}</li>`).join('')}</ul></div>` : '<div class="mt-2 meta">All correct. Nice.</div>'}
    <div class="row" style="margin-top:12px">
      <button class="ok" id="againBtn">Again</button>
      <button class="sec" id="backBtn">Back</button>
      <button class="sec" id="exportRunBtn">Export Missed</button>
    </div>`;
  const again = ui.res.querySelector('#againBtn');
  const back = ui.res.querySelector('#backBtn');
  const ex = ui.res.querySelector('#exportRunBtn');
  if (again) again.onclick = ()=> startRun({practice: state.practice});
  if (back) back.onclick = ()=>{ hide(ui.res); show(ui.cfg); };
  if (ex) ex.onclick = ()=>{
    const blob = new Blob([wrong.join("\n")], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'missed_words_this_run.txt';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  };
  updateProblemCount();
}

// Button handlers
if (ui.btnStart) ui.btnStart.onclick = ()=> startRun({practice:false});
if (ui.btnPractice) ui.btnPractice.onclick = ()=> startRun({practice:true});

// Session controls
function currentWord(){ return state.wordsRun[state.idx] || ''; }
if (ui.play) ui.play.onclick = ()=> speak(currentWord(), 1.0);
if (ui.repeat) ui.repeat.onclick = ()=> speak(currentWord(), 0.7);
if (ui.skip) ui.skip.onclick = ()=>{ state.idx = Math.min(state.idx + 1, state.wordsRun.length); renderItem(); };
function checkAnswer(){
  const guess = (ui.answer.value||'').trim().toUpperCase();
  const truth = currentWord();
  if (!truth) return;
  if (guess === truth) {
    state.score += 1;
    ui.score.textContent = String(state.score);
    ui.feedback.textContent = 'Correct';
    if (ui.autoNext.checked) {
      state.idx += 1;
      renderItem();
    }
  } else {
    ui.answer.classList.add('wrong');
    ui.feedback.textContent = `Correct: ${truth}`;
    if (!state.wrongList.includes(truth)) state.wrongList.push(truth);
  }
}
if (ui.submit) ui.submit.onclick = checkAnswer;
if (ui.reveal) ui.reveal.onclick = ()=>{ const t=currentWord(); if(t){ ui.feedback.textContent = `Correct: ${t}`; if(!state.wrongList.includes(t)) state.wrongList.push(t);} };

// keyboard shortcuts
root.addEventListener('keydown', (e)=>{
  if (ui.ses.classList.contains('hide')) return;
  if (e.code === 'Space') { e.preventDefault(); speak(currentWord(), 1.0); }
  if (e.code === 'Enter') { e.preventDefault(); checkAnswer(); }
  if (e.ctrlKey && e.code === 'Backspace') { e.preventDefault(); ui.answer.value=''; }
});


          })();
          </script>
        </div>
      </div>
    </div>
  </div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js?v=v7_"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js?v=v7_"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=v7_"></script>
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
const { createRoot } = ReactDOM;

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function sampleN(arr, n){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a.slice(0, Math.min(n,a.length)); }

    const BASE_SETS = {
      set1: [
        ['10-1', 'Receiving poorly'],
        ['10-2', 'Receiving well'],
        ['10-3', 'Stop transmitting'],
        ['10-4', 'OK or acknowledgement'],
        ['10-5', 'Relay'],
        ['10-6', 'Busy'],
        ['10-7', 'Out of service'],
        ['10-7-B', 'Out of service at home'],
        ['10-8', 'In service'],
        ['10-9', 'Repeat'],
      ],
      set2: [
        ['10-10', 'Out of service subject to call'],
        ['10-11', 'Transmitting too rapidly'],
        ['10-12', 'Officials or visitors present'],
        ['10-13', 'Weather or road conditions'],
        ['10-14', 'Escort or convoy'],
        ['10-15', 'En route with prisoner'],
        ['10-16', 'Pick up prisoner'],
        ['10-17', 'Pick up papers'],
        ['10-18', 'Complete present assignment as soon as possible'],
        ['10-19', 'Return or returning to station'],
        ['10-20', 'Location'],
      ],
      set3: [
        ['10-21', 'Call by telephone'],
        ['10-21-A', 'Advise my home I will return at'],
        ['10-21-B', 'Call your home by telephone'],
        ['10-22', 'Cancel last message or assignment'],
        ['10-23', 'Standby'],
        ['10-25', 'Do you have contact with_____?'],
        ['10-27', 'Request want and warrant check of a person'],
        ['10-28', 'Registration request'],
        ['10-29', 'Check for stolen or wanted'],
        ['10-30', 'No wants your subject'],
      ],
      set4: [
        ['10-30-C', 'Computer or switcher unavailable'],
        ['10-31', 'Subject has record but no wants'],
        ['10-32', 'Subject wanted, are you clear to copy?'],
        ['10-32-F', 'Subject wanted, felony type hit'],
        ['10-33', 'Standby, emergency traffic only'],
        ['10-34', 'Resume normal radio traffic'],
        ['10-35', 'Confidential information'],
        ['10-36', 'Correct time'],
        ['10-37', 'Name of operator on duty?'],
        ['10-39', 'Message delivered'],
      ],
      set5: [
        ['10-42', 'Pick up officer'],
        ['10-45', 'Service your equipment'],
        ['10-46', 'Standby, I am proceeding to a better location'],
        ['10-48', 'I am now ready to take information'],
        ['10-49', 'Proceed to'],
      ],
      set6: [
        ['10-86', 'Traffic check, do you have traffic for this unit/dispatcher?'],
        ['10-87', 'Meet at'],
        ['10-97', 'Arrived at location'],
        ['10-98', 'Finished last assignment'],
      ],
      agencyA: [
        ['10', 'California Highway Patrol'],
        ['11', 'U.C. Irvine Police'],
        ['12', 'Orange County Transportation Authority'],
        ['13', 'C.S.U. Fullerton Police'],
        ['14', 'Probation'],
        ['17', 'OC Animal Control'],
        ['18', 'Sheriff-Coroner'],
        ['19', 'District Attorney'],
      ],
      agencyB: [
        ['21', 'La Habra Police'],
        ['22', 'Brea Police'],
        ['23', 'Buena Park Police'],
        ['24', 'Fullerton Police'],
        ['25', 'Placentia Police'],
        ['26', 'Anaheim Police'],
        ['29', 'Saddleback College Police'],
        ['31', 'Santa Ana Police'],
      ],
      agencyC: [
        ['32', 'Garden Grove Police'],
        ['33', 'Orange Police'],
        ['34', 'Tustin Police'],
        ['36', 'Cypress Police'],
        ['37', 'La Palma Police'],
        ['38', 'Irvine Valley College Police'],
        ['39', 'Irvine Police'],
        ['40', 'Fountain Valley Police'],
        ['41', 'Seal Beach Police'],
      ],
      agencyD: [
        ['42', 'Huntington Beach Police'],
        ['43', 'Newport Beach Police'],
        ['44', 'Costa Mesa Police'],
        ['45', 'Laguna Beach Police'],
        ['47', 'Westminster Police'],
        ['48', 'Los Alamitos Police'],
        ['49', 'Santa Ana School Police'],
        ['54', 'OCSD/Harbor Patrol'],
        ['59', 'California State Parks'],
      ],
    };

    const ADDITIONAL_CODES = [
      ['11350', 'Possession of controlled substance'],
      ['11357', 'Possession of marijuana'],
      ['187', 'Murder'],
      ['207', 'Kidnapping'],
      ['207-A', 'Attempt kidnapping'],
      ['211', 'Robbery'],
      ['211-S', 'Robbery, silent alarm'],
      ['215', 'Carjacking'],
      ['220', 'Attempt rape'],
      ['240', 'Misdemeanor assault'],
      ['242', 'Battery'],
      ['245', 'Assault with deadly weapon'],
      ['246', 'Discharge of firearms at inhabited dwelling or vehicle'],
      ['261', 'Rape'],
      ['273-A', 'Willful cruelty to children'],
      ['273.5', 'Domestic violence'],
      ['288', 'Lewd and lascivious conduct'],
      ['314', 'Indecent exposure'],
      ['390', 'Drunk'],
      ['390-C', 'Drunk in car'],
      ['390-D', 'Drunk down'],
      ['415', 'Disturbing the peace'],
      ['415-A', 'Disturbing the peace / auto(s) involved'],
      ['415-E', 'Disturbing the peace / music or party'],
      ['415-F', 'Disturbing the peace / family row'],
      ['415-G', 'Disturbing the peace / gang'],
      ['415-M', 'Disturbing the peace / mechanical - miscellaneous'],
      ['417', 'Subject with a firearm/weapon'],
      ['451', 'Arson'],
      ['459', 'Burglary'],
      ['459-A', 'Burglar alarm audible'],
      ['459-S', 'Burglar alarm silent'],
      ['470', 'Forgery'],
      ['480', 'Hit and run felony'],
      ['481', 'Hit and run misdemeanor'],
      ['483', 'Hit and run parked vehicle'],
      ['484', 'Theft/larceny'],
      ['487', 'Grand theft'],
      ['488', 'Petty Theft'],
      ['496', 'Concealing or receiving stolen property'],
      ['502', 'Drunk driver'],
      ['503', 'Stolen car/motorcycle/boat'],
      ['503-T', 'Stolen vehicle tracking system activation'],
      ['504', 'Car tampering or stripping'],
      ['505-A', 'Reckless driver/driving'],
      ['510', 'Speeding or racing vehicle'],
      ['586', 'Illegal parking'],
      ['594', 'Malicious mischief'],
      ['597', 'Cruelty to animals'],
      ['653-M', 'Obscene telephone calls'],
      ['664-187', 'Attempt murder'],
      ['900', 'Traffic accident, unknown if injury'],
      ['901-K', 'Ambulance dispatched'],
      ['901-N', 'Ambulance needed'],
      ['901-T', 'Injury traffic accident'],
      ['901-Y', 'Is ambulance needed?'],
      ['902-H', 'En route hospital'],
      ['902-M', 'Medical aid'],
      ['902-T', 'Non-injury traffic accident'],
      ['903', 'Plane crash'],
      ['903-L', 'Low flying plane'],
      ['904', 'Fire'],
      ['904-A', 'Fire alarm'],
      ['904-B', 'Boat fire'],
      ['904-C', 'Car fire'],
      ['904-G', 'Grass fire'],
      ['904-I', 'Illegal fire'],
      ['904-M', 'Trash fire'],
      ['904-S', 'Structure fire'],
      ['905', 'Animal information'],
      ['905-B', 'Animal bite'],
      ['905-D', 'Animal dead'],
      ['905-H', 'Animal in heat'],
      ['905-I', 'Animal injured'],
      ['905-L', 'Animal loose'],
      ['905-N', 'Animal noise'],
      ['905-R', 'Animal rabies suspect'],
      ['905-S', 'Animal stray'],
      ['905-X', 'Animal field euthanasia'],
      ['906', 'Rescue'],
      ['907-K', 'Paramedic team dispatched'],
      ['907-N', 'Paramedic team needed'],
      ['907-Y', 'Is paramedic team needed?'],
      ['909', 'Traffic information'],
      ['909-C', 'Traffic congestion / control'],
      ['909-F', 'Flares needed'],
      ['909-T', 'Traffic hazard'],
      ['910', 'Can handle call'],
      ['911-B', 'Contact the officer'],
      ['912', 'Are we clear to/for ____?'],
      ['913', 'You are clear to/for'],
      ['914-A', 'Attempted suicide'],
      ['914-C', 'Coroner needed'],
      ['914-D', 'Doctor needed'],
      ['914-S', 'Suicide'],
      ['917-A', 'Abandoned vehicle'],
      ['918', 'Mental case (same as W&I Code 5150)'],
      ['918-V', 'Violent mental case'],
      ['919', 'Keep the peace'],
      ['920-A', 'Missing adult (18 years and older)'],
      ['920-C', 'Missing child (12 years and under)'],
      ['920-F', 'Found child'],
      ['920-J', 'Missing juvenile (13 to 17 years)'],
      ['921', 'Prowler'],
      ['922', 'Illegal peddling'],
      ['924', 'Station detail'],
      ['924-D', 'Station detail / desk'],
      ['924-E', 'Food for prisoners'],
      ['924-R', 'Report writing'],
      ['925', 'Suspicious person'],
      ['925-C', 'Suspicious person in car'],
      ['925-V', 'Suspicious vehicle'],
      ['926', 'Tow truck needed'],
      ['926-A', 'Tow truck dispatched'],
      ['927', 'Unknown trouble'],
      ['927-D', 'Investigate dead body'],
      ['927-H', '9-1-1 hang up'],
      ['928', 'Found property'],
      ['928-B', 'Found bicycle'],
      ['929', 'Investigate person down'],
      ['930', 'See the man'],
      ['931', 'See the woman'],
      ['932', 'Open door'],
      ['933', 'Open window'],
      ['949', 'Gasoline spill'],
      ['952', 'Report on conditions'],
      ['954', 'Off the air at scene'],
      ['960', 'Car stop, request follow-up'],
      ['960-X', 'Car stop, expedite follow-up, dangerous suspects'],
      ['961', 'Car stop, no follow-up needed'],
      ['962', 'Subject armed and dangerous, clear to copy?'],
      ['966', 'Sniper activity'],
      ['966-A', 'Shots heard, no suspect information'],
      ['967', 'Outlaw motorcycle movement'],
      ['968', 'Request want and warrant check of a person'],
      ['970', 'Illegal surfing'],
      ['971', 'Boat over'],
      ['972', 'Boat speeding'],
      ['973', 'Swimmer on boat'],
      ['974', 'Boat adrift'],
      ['975', 'Wreckage adrift'],
      ['976', 'Oil slick'],
      ['977', 'Check mooring line'],
      ['978', 'Vessel aground'],
      ['979', 'Vessel sinking'],
      ['980', 'Radioactive materials present or involved'],
      ['981', 'Need radiological monitoring team'],
      ['982', 'Bomb threat'],
      ['983', 'Explosion'],
      ['984', 'Hazardous materials spill'],
      ['985', 'Riot or major disturbance'],
      ['997', 'Officer needs assistance from own agency units only. Urgent'],
      ['998', 'Officer involved in gun battle'],
      ['999', 'Officer needs help, any units respond. Emergency!'],

      ['Code 1', 'Routine. Take this call next'],
      ['Code 2', 'Urgent. Expedite, but obey all traffic laws. No red light or siren'],
      ['Code 3', 'Emergency. Proceed immediately using red light and siren'],
      ['Code 4', 'No further assistance needed'],
      ['Code 4-A', 'No further assistance needed, suspect at large in the area'],
      ['Code 5', 'Stake out. Other units stay away unless dispatched in response to a call'],
      ['Code 6', 'Out for investigation'],
      ['Code 7', 'Out of service to eat'],
      ['Code 7-B', 'Out of service to eat at home'],
      ['Code 9', 'Jail break'],
      ['Code 12', 'Patrol your assigned district and report extent of disaster damage'],
      ['Code 13', 'Activate major disaster plan or perform major disaster duties'],
      ['Code 14', 'Resume normal operations (used only with Code 12 & 13)'],
      ['Code 20', 'Notify news media'],
      ['Code 20-D', 'Request departmental photographer'],
      ['Code 99', 'Emergency situation. Radio emergency button has been pressed'],
      ['Code 200', 'FD requests LE assist: potentially violent situation with fire units on scene'],
      ['Code 300', 'FD requests LE assist: immediate threat or danger to fire units on scene'],
      ['Code Alex', 'Establish countywide LE observation checkpoint plan'],
      ['Code Charlie', 'Pre-planned LE mutual aid when emergency/riot anticipated (not yet requested)'],
      ['Code Charlie Checkmate', 'Actual mutual aid call for assistance'],
    ];

    function chunkInto(prefix, list, size = 10) {
      const out = {};
      const order = [];
      for (let i = 0; i < list.length; i += size) {
        const key = `${prefix}${order.length + 1}`;
        out[key] = list.slice(i, i + size);
        order.push(key);
      }
      return { sets: out, order };
    }

    const { sets: CODE_GROUPS, order: CODES_ORDER } = chunkInto('codes', ADDITIONAL_CODES);

    const ORDER = [
      'set1','set2','set3','set4','set5','set6',
      ...CODES_ORDER,
      'agencyA','agencyB','agencyC','agencyD',
    ];

    const ALL_SETS = { ...BASE_SETS, ...CODE_GROUPS };

    function buildDeck({ selectedSets, bothDirections, backOnly, onlyItems }) {
      let pairs = [];
      if (onlyItems && onlyItems.length) {
        pairs = onlyItems;
      } else {
        ORDER.forEach((key) => {
          if (selectedSets[key]) pairs = pairs.concat(ALL_SETS[key]);
        });
      }
      const cards = [];
      for (const [code, text] of pairs) {
        if (backOnly) {
          cards.push({ id: `${text}→${code}`, front: text, back: code, pair: [code, text] });
        } else {
          cards.push({ id: `${code}→${text}`, front: code, back: text, pair: [code, text] });
          if (bothDirections) {
            cards.push({ id: `${text}→${code}`, front: text, back: code, pair: [code, text] });
          }
        }
      }
      return shuffle(cards);
    }

    function usePomodoro(defaultWork = 25, defaultBreak = 5, soundOn = true) {
      const [workMins, setWorkMins] = React.useState(defaultWork);
      const [breakMins, setBreakMins] = React.useState(defaultBreak);
      const [secondsLeft, setSecondsLeft] = React.useState(workMins * 60);
      const [label, setLabel] = React.useState('Work');
      const [running, setRunning] = React.useState(false);

      React.useEffect(() => {
        setSecondsLeft((label === 'Work' ? workMins : breakMins) * 60);
      }, [workMins, breakMins, label]);

      React.useEffect(() => {
        if (!running) return;
        const id = setInterval(() => {
          setSecondsLeft((s) => {
            if (s <= 1) {
              const next = label === 'Work' ? 'Break' : 'Work';
              if (soundOn) {
                try {
                  const ctx = new (window.AudioContext || window.webkitAudioContext)();
                  const osc = ctx.createOscillator();
                  const gain = ctx.createGain();
                  osc.type = 'sine';
                  osc.frequency.value = 660;
                  osc.connect(gain);
                  gain.connect(ctx.destination);
                  osc.start();
                  setTimeout(() => { osc.stop(); ctx.close(); }, 150);
                } catch {}
              }
              setLabel(next);
              return (next === 'Work' ? workMins : breakMins) * 60;
            }
            return s - 1;
          });
        }, 1000);
        return () => clearInterval(id);
      }, [running, label, workMins, breakMins, soundOn]);

      const mm = String(Math.floor(secondsLeft / 60)).padStart(2, '0');
      const ss = String(secondsLeft % 60).padStart(2, '0');

      return {
        workMins, setWorkMins, breakMins, setBreakMins,
        mm, ss, label, running,
        start: () => setRunning(true),
        pause: () => setRunning(false),
        reset: () => { setRunning(false); setLabel('Work'); setSecondsLeft(workMins * 60); },
        skip: () => setLabel((l) => (l === 'Work' ? 'Break' : 'Work')),
      };
    }

    function TenCodesTrainer() {
      const INITIAL_SELECTED = React.useMemo(() => {
        const base = Object.fromEntries(ORDER.map((k) => [k, false]));
        base.set1 = true;
        base.set2 = true;
        return base;
      }, []);

      const [stage, setStage] = useState('menu');
      const [selectedSets, setSelectedSets] = useState(INITIAL_SELECTED);
      const [bothDirections, setBothDirections] = useState(true);
      const [backOnly, setBackOnly] = useState(false);
      const [endless, setEndless] = useState(false);
      const [soundOn, setSoundOn] = useState(true);
      const [practiceMode, setPracticeMode] = useState(false);
      const [poolEnd, setPoolEnd] = useState(0);
      const practiceInitRef = useRef(false);
      const audioCtxRef = useRef(null);

      useEffect(() => {
        if (practiceMode && stage === 'quiz' && !practiceInitRef.current && deck.length > 0) {
          const ord = deck.map((_, i) => i);
          setOrder(ord.slice(0, 1));
          setIdx(0);
          setShowBack(false);
          practiceInitRef.current = true;
        }
        if (stage !== 'quiz') {
          practiceInitRef.current = false;
        }
      }, [practiceMode, stage, deck]);
      
      const [deck, setDeck] = useState([]);
      const [order, setOrder] = useState([]);
      const [idx, setIdx] = useState(0);
      const [showBack, setShowBack] = useState(false);
      const [score, setScore] = useState(0);
      const [wrong, setWrong] = useState([]);
      const [round, setRound] = useState(1);
      const [showList, setShowList] = useState(false);

      const [exam, setExam] = useState(null); // {items: [...], i, score, wrong:[]}
      const current = useMemo(() => (order.length ? deck[order[idx]] : null), [deck, order, idx]);
      const pomo = usePomodoro(25, 5, soundOn);

      function getCtx() {
        if (!audioCtxRef.current) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (Ctx) audioCtxRef.current = new Ctx();
        }
        return audioCtxRef.current;
      }

      function playBeep(freq = 440, duration = 0.12, type = 'sine') {
        if (!soundOn) return;
        const ctx = getCtx();
        if (!ctx) return;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(ctx.destination);
        const now = ctx.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
        osc.start(now);
        osc.stop(now + duration + 0.02);
      }

      function startQuiz({ fromMissed = false } = {}) {
  const newDeck = buildDeck({ selectedSets, bothDirections, backOnly, onlyItems: fromMissed ? wrong : undefined });
  const ord = newDeck.map((_, i) => i);
  setDeck(newDeck);
  // Reset practice-mode pool every time a quiz starts so "Add next card" works from 1 again
  if (practiceMode) {
    setPoolEnd(0);
    setOrder([0]);
  } else {
    setOrder(shuffle(ord));
  }
  setIdx(0);
  setShowBack(false);
  setScore(0);
  setWrong([]);
  practiceInitRef.current = false; // ensure the init effect can run again
  setStage('quiz');
}

      function handleAnswer(correct) {
        if (!showBack) {
          setShowBack(true);
          return;
        }
        if (current) {
          if (correct) {
            setScore((s) => s + 1);
            playBeep(880, 0.1, 'sine');
          } else {
            setWrong((w) => {
              const already = w.some(([c, t]) => c === current.pair[0] && t === current.pair[1]);
              return already ? w : [...w, current.pair];
            });
            playBeep(220, 0.16, 'square');
          }
        }
        advance();
      }

      function advance() {
        if (practiceMode) {
          const poolLast = Math.min(poolEnd, order.length - 1);
          if (idx + 1 > poolLast) {
            setIdx(0);
            setShowBack(false);
          } else {
            setIdx((i) => i + 1);
            setShowBack(false);
          }
          return;
        }
        const last = idx + 1 >= order.length;
        if (last) {
          if (endless) {
            const newOrder = shuffle(order.map((_, i) => i));
            setOrder(newOrder);
            setIdx(0);
            setShowBack(false);
          } else {
            setStage('summary');
          }
        } else {
          setIdx((i) => i + 1);
          setShowBack(false);
        }
      }

      const totalCount = useMemo(() => {
        const acc = {};
        ORDER.forEach((k) => { acc[k] = ALL_SETS[k].length; });
        return acc;
      }, []);

      const referencePairs = useMemo(() => {
        let pairs = [];
        ORDER.forEach((key) => {
          if (selectedSets[key]) pairs = pairs.concat(ALL_SETS[key]);
        });
        return pairs;
      }, [selectedSets]);

      function openSpelling(){ window.showSpelling(); }

      function startAcademyExam(){
        // 20 from selected code sets, back-only: prompt = meaning, answer = code
        let available = [];
        ORDER.forEach(k => { if(selectedSets[k]) available = available.concat(ALL_SETS[k]); });
        const code20 = sampleN(available, 20).map(([code, text]) => ({ type:'code', prompt:text, answer:code }));

        // 20 spelling from overlay list or default
        const spellList = (window.getSpellingWordList && window.getSpellingWordList()) || (window.LE_SPELLING_DEFAULT || []);
        const spell20 = sampleN(spellList, 20).map(word => ({ type:'spelling', prompt:word, answer:word }));

        const items = shuffle([...code20, ...spell20]);
        setExam({ items, i:0, score:0, wrong:[], revealed:false });
        setStage('exam');
      }

      // Exam controls helpers
      function speakWord(word, rateFactor=1){
        if(window.spellSpeak){ window.spellSpeak(word, rateFactor); }
        else {
          try {
            const u = new SpeechSynthesisUtterance(word);
            u.rate = 0.9 * rateFactor;
            speechSynthesis.cancel(); speechSynthesis.speak(u);
          } catch {}
        }
      }

      return (
        <div className="min-h-screen bg-neutral-950 text-white p-4 md:p-6">
          {/* Top bar with global actions (button moved out of reference list) */}
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-2xl font-bold">Coms Test Trainer</h1>
            <div className="flex gap-2">
              <button onClick={startAcademyExam} className="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-sm font-semibold">
                Academy Practice Test (20 radio/station & 20 spelling) 
              </button>
              <button onClick={openSpelling} className="px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-sm font-semibold">
                Open Spelling Drill
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-[260px_minmax(0,1fr)_260px] gap-4">
            <aside className="lg:sticky lg:top-4 self-start bg-neutral-900/60 rounded-xl border border-neutral-800 p-3">
              <div className="flex items-center justify-between mb-2">
                <h2 className="text-sm font-semibold">Reference list</h2>
                <button className="text-xs px-2 py-1 rounded bg-neutral-800 hover:bg-neutral-700" onClick={() => setShowList((s) => !s)}>
                  {showList ? 'Hide' : 'Show'}
                </button>
              </div>

              {showList ? (
                <div className="max-h-[60vh] overflow-auto pr-1">
                  <ul className="space-y-1 text-sm">
                    {referencePairs.map(([code, text]) => (
                      <li key={`${code}-${text}`} className="px-2 py-1 rounded">
                        <span className="text-neutral-300">{code}</span> — {text}
                      </li>
                    ))}
                  </ul>
                  {referencePairs.length === 0 && (
                    <p className="text-xs text-neutral-500">No sets selected yet.</p>
                  )}
                </div>
              ) : (
                <p className="text-xs text-neutral-500">Click Show to view the current deck's full list.</p>
              )}
            </aside>

            <main className="flex flex-col items-center">
              {stage === 'menu' && (
                <div className="w-full max-w-xl space-y-4">
                  <p className="text-neutral-400 text-sm">Toggle the lists you want to study, then start the quiz. Both-directions doubles the deck for stronger recall.</p>

                  <div className="rounded-xl bg-neutral-900 p-4 space-y-3 border border-neutral-800">
                    {[1, 2, 3, 4, 5, 6].map((n) => (
                      <div key={`ten-${n}`} className="flex items-center justify-between">
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={selectedSets[`set${n}`] || false}
                            onChange={(e) => setSelectedSets((s) => ({ ...s, [`set${n}`]: e.target.checked }))}
                          />
                          <span>
                            {`Set ${n} `}
                            {n === 1 && '(10-1 to 10-9 + 10-7-B)'}
                            {n === 2 && '(10-10 to 10-20)'}
                            {n === 3 && '(10-21 to 10-30)'}
                            {n === 4 && '(10-30-C to 10-39)'}
                            {n === 5 && '(10-42 to 10-49)'}
                            {n === 6 && '(10-86 to 10-98)'}
                          </span>
                        </label>
                        <span className="text-xs text-neutral-400">{totalCount[`set${n}`]} items</span>
                      </div>
                    ))}

                    <div className="pt-3 mt-4 border-t border-neutral-800">
                      <div className="font-semibold mb-2">Penal & Radio Codes (11350–999)</div>
                      {Array.from({length: Math.ceil(ADDITIONAL_CODES.length/10)}, (_,i)=>`codes${i+1}`).map((key, i) => (
                        <div key={key} className="flex items-center justify-between">
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={selectedSets[key] || false}
                              onChange={(e) => setSelectedSets((s) => ({ ...s, [key]: e.target.checked }))}
                            />
                            <span>{`Set ${i + 1}`}</span>
                          </label>
                          <span className="text-xs text-neutral-400">{ALL_SETS[key].length} items</span>
                        </div>
                      ))}
                    </div>

                    <div className="pt-3 mt-4 border-t border-neutral-800">
                      <div className="font-semibold mb-2">Station Numbers / Agencies</div>
                      {['agencyA', 'agencyB', 'agencyC', 'agencyD'].map((key, i) => (
                        <div key={key} className="flex items-center justify-between">
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={selectedSets[key] || false}
                              onChange={(e) => setSelectedSets((s) => ({ ...s, [key]: e.target.checked }))}
                            />
                            <span>
                              {`Agencies ${String.fromCharCode(65 + i)} ${
                                key === 'agencyA'
                                  ? '(10–19)'
                                  : key === 'agencyB'
                                  ? '(21–31)'
                                  : key === 'agencyC'
                                  ? '(32–41)'
                                  : '(42, 43, 44, 45, 47, 48, 49, 54, 59)'
                              }`}
                            </span>
                          </label>
                          <span className="text-xs text-neutral-400">{ALL_SETS[key].length} items</span>
                        </div>
                      ))}
                    </div>

                    <div className="pt-2 border-t border-neutral-800 mt-2 space-y-2">
                      <label className="flex items-center gap-2">
                        <input type="checkbox" checked={practiceMode} onChange={(e) => setPracticeMode(e.target.checked)} />
                        <span>Practice mode (ordered, one-at-a-time with “Add next”)</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={bothDirections}
                          disabled={backOnly}
                          onChange={(e) => setBothDirections(e.target.checked)}
                        />
                        <span>Include both directions (code → meaning and meaning → code)</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input type="checkbox" checked={backOnly} onChange={(e) => setBackOnly(e.target.checked)} />
                        <span>Back-side only (show meaning; you recall the code)</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input type="checkbox" checked={endless} onChange={(e) => setEndless(e.target.checked)} />
                        <span>Endless mode (no summary, continuous shuffle)</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input type="checkbox" checked={soundOn} onChange={(e) => setSoundOn(e.target.checked)} />
                        <span>Sound effects (correct/wrong cues)</span>
                      </label>
                      <p className="text-xs text-neutral-500">Back-side only mirrors academy tests. When enabled, the both-directions toggle is ignored.</p>
                    </div>
                  </div>

                  <div className="flex gap-3 flex-wrap">
                    <button onClick={() => startQuiz()} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold">
                      Start Quiz
                    </button>
                    <button onClick={() => setSelectedSets(Object.fromEntries(ORDER.map((k) => [k, true])))} className="px-4 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">
                      Select All
                    </button>
                    <button onClick={() => setSelectedSets(Object.fromEntries(ORDER.map((k) => [k, false])))} className="px-4 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">
                      Clear
                    </button>
                  </div>
                </div>
              )}

              {stage === 'quiz' && current && (<>
                
                  {practiceMode && (
                    <div className="rounded-xl bg-neutral-900 p-3 border border-neutral-800 mb-2">
                      <div className="flex items-center justify-between text-sm">
                        <div>Practice pool: <span className="font-semibold">{Math.min(poolEnd + 1, deck.length)}</span> / {deck.length}</div>
                        <div className="text-neutral-400">Ordered learning</div>
                      </div>
                      <div className="mt-2 flex gap-2 flex-wrap">
                        <button
                          onClick={() => {
                            const next = Math.min(poolEnd + 1, deck.length - 1);
                            if (next !== poolEnd) {
                              setPoolEnd(next);
                              const base = deck.map((_, i) => i);
                              setOrder(base.slice(0, next + 1));
                              setIdx(0);
                              setShowBack(false);
                            }
                          }}
                          className={"px-3 py-2 rounded-lg " + (poolEnd + 1 >= deck.length ? "bg-neutral-800 cursor-not-allowed" : "bg-amber-600 hover:bg-amber-700")}
                          disabled={poolEnd + 1 >= deck.length}
                        >
                          Add next card
                        </button>
                        <button onClick={() => { setStage('summary'); }} className="px-3 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">Finish practice</button>
                      </div>
                    </div>
                  )}
    <div className="w-full max-w-xl space-y-4">
                  <div className="flex items-center justify-between text-sm text-neutral-400">
                    <div>Round {round}</div>
                    <div className="flex items-center gap-2">
                      <div>
                        Question {idx + 1} / {order.length}
                      </div>
                      <button onClick={() => setStage('menu')} className="ml-2 text-xs px-2 py-1 rounded bg-neutral-800 hover:bg-neutral-700">
                        Menu
                      </button>
                    </div>
                  </div>
                  <div
                    className="p-6 rounded-2xl bg-neutral-900 hover:bg-neutral-800 transition cursor-pointer shadow-lg"
                    onClick={() => setShowBack(!showBack)}
                  >
                    <h2 className="text-2xl font-bold text-center mb-2">{showBack ? current.back : current.front}</h2>
                    <p className="text-center text-neutral-400 text-sm">Click to flip</p>
                  </div>
                  <div className="flex gap-3 flex-wrap">
                    <button onClick={() => handleAnswer(true)} className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 font-semibold">
                      I was right
                    </button>
                    <button onClick={() => handleAnswer(false)} className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-semibold">
                      I was wrong
                    </button>
                    <button onClick={advance} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold">
                      Skip/Next
                    </button>
                    <button onClick={() => startQuiz()} className="px-4 py-2 rounded-lg bg-neutral-700 hover:bg-neutral-600 font-semibold">
                      Restart round
                    </button>
                  </div>
                  <div className="text-sm text-neutral-300">Score: {score} / {idx + 1}</div>
                </div>
              </>
              )}

              {stage === 'exam' && exam && (
                <ExamPanel exam={exam} setExam={setExam} setStage={setStage} speakWord={speakWord} />
              )}

              {stage === 'summary' && (
                <div className="w-full max-w-xl space-y-4">
                  <h2 className="text-xl font-bold">Round complete</h2>
                  <div className="rounded-xl bg-neutral-900 p-4 space-y-2">
                    <div>
                      Score: <span className="font-semibold">{score} / {order.length}</span>
                    </div>
                    <div>
                      Accuracy: <span className="font-semibold">{Math.round((score / order.length) * 100)}%</span>
                    </div>
                    <div>
                      Missed: <span className="font-semibold">{wrong.length}</span>
                    </div>
                  </div>

                  <div className="flex flex-wrap gap-3">
                    <button onClick={() => {
                      if (wrong.length === 0) {
                        setRound((r) => r + 1);
                        startQuiz();
                      } else {
                        setRound((r) => r + 1);
                        const newDeck = buildDeck({ selectedSets, bothDirections, backOnly, onlyItems: wrong });
                        const ord = newDeck.map((_, i) => i);
                        setDeck(newDeck);
                        setOrder(shuffle(ord));
                        setIdx(0);
                        setShowBack(false);
                        setScore(0);
                        setWrong([]);
                        setStage('quiz');
                      }
                    }} className="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 font-semibold">
                      Retry missed only
                    </button>
                    <button onClick={() => { setRound((r) => r + 1); startQuiz(); }} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold">
                      New round (same selection)
                    </button>
                    <button onClick={() => setStage('menu')} className="px-4 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">
                      Return to menu
                    </button>
                  </div>

                  {wrong.length > 0 && (
                    <div className="text-sm text-neutral-400">
                      <div className="mt-3 mb-1 font-semibold text-neutral-300">You missed:</div>
                      <ul className="list-disc list-inside space-y-1">
                        {wrong.map(([code, text]) => (
                          <li key={`${code}-${text}`}>
                            <span className="text-neutral-300">{code}</span> — {text}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              )}
            </main>

            <aside className="lg:sticky lg:top-4 self-start bg-neutral-900/60 rounded-xl border border-neutral-800 p-3">
              <h2 className="text-sm font-semibold mb-2">Pomodoro</h2>
              <div className="text-xs text-neutral-400 mb-2">Persistent timer for your study blocks</div>
              <PomodoroPanel />
            </aside>
          </div>
        </div>
      );
    }

    function PomodoroPanel(){
      const [soundOn, setSoundOn] = useState(true);
      const [practiceMode, setPracticeMode] = useState(false);
      const [poolEnd, setPoolEnd] = useState(0);
      const practiceInitRef = useRef(false);
      const pomo = usePomodoro(25, 5, soundOn);
      return (
        <div>
          <div className="text-center">
            <div className="text-neutral-300 text-xs mb-1">{pomo.label} session</div>
            <div className="text-3xl font-bold tracking-widest">{pomo.mm}:{pomo.ss}</div>
          </div>
          <div className="flex gap-2 mt-3">
            {!pomo.running ? (
              <button className="flex-1 px-3 py-2 rounded bg-green-600 hover:bg-green-700 text-sm" onClick={pomo.start}>Start</button>
            ) : (
              <button className="flex-1 px-3 py-2 rounded bg-amber-600 hover:bg-amber-700 text-sm" onClick={pomo.pause}>Pause</button>
            )}
            <button className="px-3 py-2 rounded bg-neutral-800 hover:bg-neutral-700 text-sm" onClick={pomo.reset}>Reset</button>
            <button className="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-sm" onClick={pomo.skip}>Skip</button>
          </div>
          <div className="mt-3 grid grid-cols-2 gap-2 text-xs">
            <label className="flex items-center justify-between gap-2">
              <span>Work (min)</span>
              <input type="number" min="1" max="120" value={pomo.workMins} onChange={(e) => pomo.setWorkMins(Number(e.target.value || 0))} className="w-16 px-2 py-1 rounded bg-neutral-800 border border-neutral-700" />
            </label>
            <label className="flex items-center justify-between gap-2">
              <span>Break (min)</span>
              <input type="number" min="1" max="60" value={pomo.breakMins} onChange={(e) => pomo.setBreakMins(Number(e.target.value || 0))} className="w-16 px-2 py-1 rounded bg-neutral-800 border border-neutral-700" />
            </label>
          </div>
          <label className="flex items-center gap-2 mt-3 text-xs">
            <input type="checkbox" checked={soundOn} onChange={(e)=>setSoundOn(e.target.checked)} />
            <span>Sound effects</span>
          </label>
        </div>
      );
    }

    function ExamPanel({ exam, setExam, setStage, speakWord }){
      const [input, setInput] = useState('');
      const item = exam.items[exam.i];
      const total = exam.items.length;

      function submit(){
        const guess = input.trim();
        const correct = item.type === 'spelling'
          ? guess === item.answer
          : guess.toUpperCase() === item.answer.toUpperCase();
        const next = { ...exam };
        if(correct) next.score += 1; else next.wrong.push({ ...item, guess });
        next.i += 1;
        setInput('');
        if(next.i >= total){
          setExam(next);
        } else {
          setExam(next);
        }
      }

      if(exam.i >= total){
        const pct = Math.round(exam.score/total*100);
        return (
          <div className="w-full max-w-xl space-y-4">
            <h2 className="text-xl font-bold">Academy Practice Test</h2>
            <div className="rounded-xl bg-neutral-900 p-4 space-y-2">
              <div>Score: <span className="font-semibold">{exam.score} / {total}</span> <span className="text-neutral-400">({pct}%)</span></div>
              <div>Spelling items: 20 | Code items: 20</div>
            </div>
            {exam.wrong.length > 0 && (
              <div className="rounded-xl bg-neutral-900 p-4">
                <div className="font-semibold mb-2">Missed items ({exam.wrong.length})</div>
                <ul className="list-disc list-inside space-y-1 text-sm">
                  {exam.wrong.map((w, idx) => (
                    <li key={idx}>
                      {w.type === 'spelling' ? (
                        <span>Spelling: correct <span className="text-neutral-300">{w.answer}</span> | you typed <span className="text-red-400">{w.guess||'(blank)'}</span></span>
                      ) : (
                        <span>Code for “{w.prompt}” = <span className="text-neutral-300">{w.answer}</span> | you typed <span className="text-red-400">{w.guess||'(blank)'}</span></span>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            )}
            <div className="flex gap-3 flex-wrap">
              <button onClick={()=>setStage('menu')} className="px-4 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">Return to menu</button>
              <button onClick={()=>{
                // quick restart with fresh draw
                setStage('menu');
                setTimeout(()=>{ /* user can hit the top-bar button again; nothing brittle here */ }, 0);
              }} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold">New test</button>
            </div>
          </div>
        );
      }

      return (
        <div className="w-full max-w-xl space-y-4">
          <div className="flex items-center justify-between text-sm text-neutral-400">
            <div>Item {exam.i + 1} / {total}</div>
            <div>Score: {exam.score}</div>
          </div>

          <div className="rounded-2xl bg-neutral-900 p-4">
            {item.type === 'spelling' ? (
              <div>
                <div className="text-xs text-neutral-400 mb-1">Spelling: audio only</div>
                <div className="flex gap-2 mb-3">
                  <button onClick={()=>speakWord(item.prompt, 1.0)} className="px-3 py-2 rounded bg-neutral-800 hover:bg-neutral-700 text-sm">Play</button>
                  <button onClick={()=>speakWord(item.prompt, 0.7)} className="px-3 py-2 rounded bg-neutral-800 hover:bg-neutral-700 text-sm">Repeat (slower)</button>
                </div>
                <input value={input} onChange={e=>setInput(e.target.value)} placeholder="TYPE IN ALL CAPS" className="w-full px-3 py-2 rounded bg-neutral-800 border border-neutral-700" />
              </div>
            ) : (
              <div>
                <div className="text-xs text-neutral-400 mb-1">Code recall: enter the correct code for the meaning</div>
                <div className="text-lg font-semibold mb-3 text-center">{item.prompt}</div>
                <input value={input} onChange={e=>setInput(e.target.value)} placeholder="e.g., 10-21, 459, Code 3" className="w-full px-3 py-2 rounded bg-neutral-800 border border-neutral-700" />
              </div>
            )}
          </div>

          <div className="flex gap-2">
            <button onClick={submit} className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 font-semibold">Submit</button>
            <button onClick={()=>{ setInput(''); }} className="px-4 py-2 rounded-lg bg-neutral-800 hover:bg-neutral-700">Clear</button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TenCodesTrainer />);

    // Overlay controls
    window.showSpelling = function(){
      document.getElementById('spelling-overlay').classList.remove('hidden');
    };
    window.hideSpelling = function(){
      document.getElementById('spelling-overlay').classList.add('hidden');
    };
  </script>

<script>
(function(){
  const box = document.createElement('div');
  box.id='fatal-overlay';
  Object.assign(box.style, {position:'fixed',inset:'12px',background:'rgba(0,0,0,0.85)',color:'#fca5a5',padding:'12px 14px',border:'1px solid #b91c1c',borderRadius:'10px',fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',zIndex:99999,display:'none',overflow:'auto'});
  document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
  function show(msg){
    box.style.display='block';
    const pre = document.createElement('pre');
    pre.textContent = msg;
    box.appendChild(pre);
  }
  window.addEventListener('error', (e)=>{ show('[error] ' + (e.message||'unknown') + '\n' + (e.filename||'') + ':' + (e.lineno||'') ); });
  window.addEventListener('unhandledrejection', (e)=>{ show('[unhandledrejection] ' + (e.reason && (e.reason.stack||e.reason.message)) ); });
  setTimeout(()=>{
    // if nothing rendered in #root, nudge the dev
    const root = document.getElementById('root');
    if (root && !root.firstChild) show('No content rendered into #root. If screen is black, check console for errors.');
  }, 1500);
})();
</script>

<script>window.__BUILD_VERSION__="v7_";</script>
</body>
</html>
